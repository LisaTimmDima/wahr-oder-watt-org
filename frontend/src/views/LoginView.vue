<script setup>
import { ref, computed } from 'vue';
import { EnvelopeIcon, LockClosedIcon, UserIcon } from '@heroicons/vue/24/solid';

const emit = defineEmits(['login-successful', 'admin-login-successful']);
const mode = ref('user-login');

const email = ref('');
const playerUsername = ref('');
const password = ref('');
const adminLoginName = ref('');
const adminPassword = ref('');
const newPassword = ref('');
const confirmPassword = ref('');
const notificationMessage = ref('');
const emailRegex = /^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.(com|de|net|org|info|io)$/;
const isEmailValid = computed(() => emailRegex.test(email.value.trim()));


const currentTitle = computed(() => {
  switch(mode.value) {
    case 'forgot-password': return 'Passwort vergessen?';
    case 'forgot-password-email-sent': return 'Überprüfen Sie Ihre E-Mail.';
    case 'reset-password': return 'Neues Passwort';
    case 'register': return 'Erstellen Sie Ihr Konto';
    default: return 'Wahr oder Watt?';
  }
});

function handleForgotPasswordRequest() {
  console.log('Passwort-Reset angefordert für:', email.value);
  mode.value = 'forgot-password-email-sent';
}

function handlePasswordReset() {
  if (newPassword.value !== confirmPassword.value) {
    alert("Die Passwörter stimmen nicht überein!");
    return;
  }
  if (newPassword.value.length < 8) {
    alert("Das Passwort muss mindestens 8 Zeichen lang sein.");
    return;
  }
  console.log('Neues Passwort wird gesetzt:', newPassword.value);
  alert("Ihr Passwort wurde erfolgreich zurückgesetzt!");
  mode.value = 'user-login';
}

async function handleLogin() {
  const url = '/api/auth/login';
  const urladmin = '/api/auth/login_admin';
  let payload;

  try {
    if (mode.value === 'user-login') {
      payload = { email: email.value, password: password.value };
      const response = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      if (!response.ok) throw new Error('Login fehlgeschlagen');
      const token = await response.text();
      localStorage.setItem('jwt', token);
      emit('login-successful');
    } else if (mode.value === 'admin-login') {
      payload = { username: adminLoginName.value, password: adminPassword.value };
      const response = await fetch(urladmin, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      if (!response.ok) throw new Error('Login fehlgeschlagen');
      const token = await response.text();
      localStorage.setItem('jwt', token);
      emit('admin-login-successful');
    } else {
      return;
    }
  } catch (error) {
    alert('Fehler: ' + error.message);
  }
}

async function handleRegister() {
  if (!isEmailValid.value) {
    alert("Bitte geben Sie eine gültige E-Mail-Adresse ein.");
    return;
  }
  console.log(
    'Registrierungs-Versuch:',
    email.value,
    playerUsername.value,
    password.value
  );
    if (password.value.length < 8) {
        alert("Das Passwort muss mindestens 8 Zeichen lang sein.");
        return;
    }
  const url = '/api/auth/register';
  const payload = {
    username: playerUsername.value,
    password: password.value,
    email: email.value
  };

  try {
    const response = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    if (!response.ok) {
        // Bei einem Fehler die Server-Nachricht anzeigen, falls vorhanden
        const errorData = await response.json();
        throw new Error(errorData.message || 'Registrierung fehlgeschlagen');
    }

    // ANPASSUNG BEGINNT HIER
    // 1. Erfolgsmeldung für die Login-Ansicht setzen
    notificationMessage.value = "Dein Konto wurde erfolgreich erstellt. Du kannst dich jetzt anmelden!";

    // 2. Zur Login-Ansicht wechseln
    mode.value = 'user-login';

    // 3. Felder leeren für eine saubere Ansicht
    email.value = '';
    playerUsername.value = '';
    password.value = '';

    // Der folgende Teil wird entfernt, da der Benutzer sich selbst einloggen soll
    // const token = await response.text();
    // localStorage.setItem('jwt', token);
    // ANPASSUNG ENDET HIER

  } catch (error) {
    alert('Fehler: ' + error.message);
  }
}
</script>

<template>
  <div class="bg-gray-100 min-h-screen flex items-center justify-center p-4">
    <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md">

      <div class="text-center mb-8">
        <img src="../assets/logo.svg" alt="Wahr oder Watt?" class="mx-auto h-40 mb-4">
        <h1 class="text-2xl font-bold text-gray-800">{{ currentTitle }}</h1>
      </div>

      <form v-if="mode === 'forgot-password'" @submit.prevent="handleForgotPasswordRequest">
        <p class="text-center text-gray-600 mb-6">Geben Sie Ihre E-Mail-Adresse ein und wir senden Ihnen einen Link zum Zurücksetzen Ihres Passworts.</p>
        <div class="mb-6">
          <label for="forgot-email" class="block text-sm font-medium text-gray-700">Email</label>
          <div class="mt-1 relative">
            <span class="absolute inset-y-0 left-0 flex items-center pl-3"><EnvelopeIcon class="h-5 w-5 text-gray-400" /></span>
            <input v-model="email" type="email" id="forgot-email" class="block w-full rounded-md border-gray-300 pl-10 focus:border-blue-500 focus:ring-blue-500" placeholder="email@address.com" required>
          </div>
        </div>
        <button type="submit" class="w-full bg-gray-800 text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-700 transition-colors">Passwort zurücksetzen</button>
        <p class="text-sm text-center text-gray-600 mt-8">
          <button type="button" @click="mode = 'user-login'" class="font-medium text-blue-600 hover:underline">Zurück zu "Anmelden"</button>
        </p>
      </form>

      <div v-else-if="mode === 'forgot-password-email-sent'" class="text-center">
         <p class="text-gray-600 mb-6">Wir haben Ihnen eine Anleitung zur Passwortwiederherstellung an Ihre E-Mail-Adresse gesendet.</p>
         <p class="text-sm text-gray-500 mb-6">Haben Sie die E-Mail nicht erhalten? Überprüfen Sie Ihren Spam-Ordner oder versuchen Sie, die <button @click="handleForgotPasswordRequest" class="underline hover:text-blue-600">Nachricht erneut zu senden.</button></p>
         <button @click="mode = 'user-login'" class="w-full bg-gray-800 text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-700 transition-colors">Zurück zur Anmeldung</button>
         <button @click="mode = 'reset-password'" class="mt-4 text-xs text-gray-400 underline">(Entwickler-Shortcut: Passwort jetzt zurücksetzen)</button>
      </div>
      
      <form v-else-if="mode === 'reset-password'" @submit.prevent="handlePasswordReset">
        <p class="text-center text-gray-600 mb-6">Ihr neues Passwort muss sich von Ihrem bisherigen Passwort unterscheiden und mindestens 8 Zeichen lang sein.</p>
        <div class="mb-4">
          <label for="new-password" class="block text-sm font-medium text-gray-700">Neues Passwort</label>
          <div class="mt-1 relative">
             <span class="absolute inset-y-0 left-0 flex items-center pl-3"><LockClosedIcon class="h-5 w-5 text-gray-400" /></span>
            <input v-model="newPassword" type="password" id="new-password" class="block w-full rounded-md border-gray-300 pl-10 focus:border-blue-500 focus:ring-blue-500" placeholder="••••••••••" required>
          </div>
        </div>
        <div class="mb-6">
          <label for="confirm-password" class="block text-sm font-medium text-gray-700">Passwort bestätigen</label>
          <div class="mt-1 relative">
             <span class="absolute inset-y-0 left-0 flex items-center pl-3"><LockClosedIcon class="h-5 w-5 text-gray-400" /></span>
            <input v-model="confirmPassword" type="password" id="confirm-password" class="block w-full rounded-md border-gray-300 pl-10 focus:border-blue-500 focus:ring-blue-500" placeholder="••••••••••" required>
          </div>
        </div>
        <button type="submit" class="w-full bg-gray-800 text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-700 transition-colors">Passwort zurücksetzen</button>
         <p class="text-sm text-center text-gray-600 mt-8">
          <button type="button" @click="mode = 'user-login'" class="font-medium text-blue-600 hover:underline">Zurück zu "Anmelden"</button>
        </p>
      </form>

      <form v-else-if="mode === 'register'" @submit.prevent="handleRegister">
        <p class="text-center text-gray-600 mb-6">Erstellen Sie Ihr Konto mit Ihrer E-Mail-Adresse.</p>
        <div class="mb-4">
          <label for="reg-email" class="block text-sm font-medium text-gray-700">Email</label>
          <div class="mt-1 relative">
            <span class="absolute inset-y-0 left-0 flex items-center pl-3"><EnvelopeIcon class="h-5 w-5 text-gray-400" /></span>
            <input v-model="email" type="email" id="reg-email" class="block w-full rounded-md border-gray-300 pl-10" placeholder="email@address.com" required>
          </div>
        </div>
        <div class="mb-4">
          <label for="reg-username" class="block text-sm font-medium text-gray-700">Benutzername</label>
          <div class="mt-1 relative">
             <span class="absolute inset-y-0 left-0 flex items-center pl-3"><UserIcon class="h-5 w-5 text-gray-400" /></span>
            <input v-model="playerUsername" type="text" id="reg-username" class="block w-full rounded-md border-gray-300 pl-10" placeholder="Wähle einen Namen" required>
          </div>
        </div>
        <div class="mb-6">
          <label for="reg-password" class="block text-sm font-medium text-gray-700">Passwort</label>
          <div class="mt-1 relative">
             <span class="absolute inset-y-0 left-0 flex items-center pl-3"><LockClosedIcon class="h-5 w-5 text-gray-400" /></span>
            <input v-model="password" type="password" id="reg-password" class="block w-full rounded-md border-gray-300 pl-10" placeholder="••••••••••" required>
          </div>
        </div>
        <button type="submit" class="w-full bg-gray-800 text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-700 transition-colors">Konto erstellen</button>
        <p class="text-xs text-gray-500 mt-4 text-center">Mit der Erstellung eines Kontos erklären Sie sich mit den <a href="#" class="underline">Nutzungsbedingungen</a> und der <a href="#" class="underline">Datenschutzerklärung</a> einverstanden.</p>
        <p class="text-sm text-center text-gray-600 mt-8">
          Haben Sie bereits ein Konto? <button type="button" @click="mode = 'user-login'" class="font-medium text-blue-600 hover:underline">Hier anmelden</button>
        </p>
      </form>

      <form v-else @submit.prevent="handleLogin">
        <div class="mb-6 flex rounded-lg p-1 bg-gray-200">
          <button type="button" @click="mode = 'user-login'" :class="['w-1/2 p-2 rounded-md font-semibold transition-colors', mode === 'user-login' ? 'bg-white shadow' : 'text-gray-600']">User-Login</button>
          <button type="button" @click="mode = 'admin-login'" :class="['w-1/2 p-2 rounded-md font-semibold transition-colors', mode === 'admin-login' ? 'bg-white shadow' : 'text-gray-600']">Admin-Login</button>
        </div>
        <p v-if="mode === 'admin-login'" class="text-center text-gray-600 mb-6">Admin-Login</p>
        <p v-else class="text-center text-gray-600 mb-6">Melden Sie sich mit Ihrer E-Mail-Adresse und Ihrem Passwort an.</p>
        <div v-if="mode === 'user-login'" class="mb-4">
          <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
           <div class="mt-1 relative">
             <span class="absolute inset-y-0 left-0 flex items-center pl-3"><EnvelopeIcon class="h-5 w-5 text-gray-400" /></span>
            <input v-model="email" type="email" id="email" class="block w-full rounded-md border-gray-300 pl-10" placeholder="email@address.com" required>
          </div>
        </div>
        <div v-if="mode === 'admin-login'" class="mb-4">
          <label for="username" class="block text-sm font-medium text-gray-700">Login</label>
           <div class="mt-1 relative">
             <span class="absolute inset-y-0 left-0 flex items-center pl-3"><UserIcon class="h-5 w-5 text-gray-400" /></span>
            <input v-model="adminLoginName" type="text" id="username" class="block w-full rounded-md border-gray-300 pl-10" placeholder="Username" required>
          </div>
        </div>
        <div class="mb-2">
          <label for="password" class="block text-sm font-medium text-gray-700">Passwort</label>
          <div class="mt-1 relative">
             <span class="absolute inset-y-0 left-0 flex items-center pl-3"><LockClosedIcon class="h-5 w-5 text-gray-400" /></span>
             <input v-if="mode === 'user-login'" v-model="password" type="password" id="password" class="block w-full rounded-md border-gray-300 pl-10" placeholder="••••••••••" required>
             <input v-if="mode === 'admin-login'" v-model="adminPassword" type="password" id="admin-password" class="block w-full rounded-md border-gray-300 pl-10" placeholder="••••••••••" required>
          </div>
        </div>
        <div class="text-right mb-6 h-6">
          <button v-if="mode === 'user-login'" type="button" @click="mode = 'forgot-password'" class="text-sm font-medium text-blue-600 hover:underline">Passwort vergessen?</button>
        </div>
        <button type="submit" class="w-full bg-gray-800 text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-700 transition-colors">Anmelden</button>
        <p class="text-sm text-center text-gray-600 mt-8">
          Sie haben noch kein Konto? <button type="button" @click="mode = 'register'" class="font-medium text-blue-600 hover:underline">Hier registrieren</button>
        </p>
      </form>

    </div>
  </div>
</template>